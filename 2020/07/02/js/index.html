<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>js手写 | 前端笔记</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="luhu,luhu's Blog">
  
  <meta name="description" content="手写bind12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989910010">
<meta property="og:type" content="article">
<meta property="og:title" content="js手写">
<meta property="og:url" content="https://luhu9012.github.io/2020/07/02/js/index.html">
<meta property="og:site_name" content="前端笔记">
<meta property="og:description" content="手写bind12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989910010">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2020-12-14T09:14:51.487Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="js手写">
<meta name="twitter:description" content="手写bind12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989910010">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/pace.min.js"></script>
  

  
  

</head>
</html>
<body>
  <div id="container">
      <header id="header">
    <div id="banner"></div>
    <div id="header-outer">
        <div id="header-menu" class="header-menu-pos animated">
            <div class="header-menu-container">
                <a href="/" class="left">
                    <span class="site-title">luhu&#39;s Blog</span>
                </a>
                <nav id="header-menu-nav" class="right">
                    
                    <a  href="/">
                        <i class="fa fa-home"></i>
                        <span>Home</span>
                    </a>
                    
                    <a  href="/archives">
                        <i class="fa fa-archive"></i>
                        <span>Archives</span>
                    </a>
                    
                    <a  href="/about">
                        <i class="fa fa-user"></i>
                        <span>About</span>
                    </a>
                    
                </nav>
                <a class="mobile-header-menu-button">
                    <i class="fa fa-bars"></i>
                </a>
            </div>
        </div>
        <div id="header-row">
            <div id="logo">
                <a href="/">
                    <img src="/images/logo.png" alt="logo">
                </a>
            </div>
            <div class="header-info">
                <div id="header-title">
                    
                    <h2>
                        luhu&#39;s Blog
                    </h2>
                    
                </div>
                <div id="header-description">
                    
                    <h3>
                        一个专注 WEB 开发的技术博客
                    </h3>
                    
                </div>
            </div>
            <nav class="header-nav">
                <div class="social">
                    
                        <a title="Github" target="_blank" href="//luhu9012.github.io/">
                            <i class="fa fa-github fa-2x"></i></a>
                    
                </div>
            </nav>
        </div>
    </div>
</header>
      <div class="outer">
        <section id="main" class="body-wrap"><article id="post-js" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="post-title" itemprop="name">
      js手写
    </h1>
    <div class="post-title-bar">
      <ul>
          
        <li>
          <i class="fa fa-calendar"></i>  2020-07-02
        </li>
        <li>
          <i class="fa fa-eye"></i>
          <span id="busuanzi_value_page_pv"></span>
        </li>
      </ul>
    </div>
  

          
      </header>
    
    <div class="article-entry post-content" itemprop="articleBody">
      
            
            <h4 id="手写bind"><a href="#手写bind" class="headerlink" title="手写bind"></a>手写bind</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">// 简约版</span><br><span class="line">// 缺点：1 未能体现new时的this指向  2 未能体现函数的形参个数length和name 3 如果构造函数中有返回值时未能处理</span><br><span class="line">Function.prototype.bind = Function.prototypr.bind || function (context)&#123;</span><br><span class="line">    const self = this</span><br><span class="line">    const args = Array.prototype.slice.call(arguments,1)</span><br><span class="line">    return function ()&#123;</span><br><span class="line">        const innerArgs = Array.prototype.slice.call(arguments)</span><br><span class="line">        self.apply(context,args.concat(innerArgs))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">// 进阶版</span><br><span class="line">// 缺点： 解决了构造函数调用的问题，但是对fBound.prototype的修改会影响到this.prototype</span><br><span class="line">Function.prototype.bind2 = function (context) &#123;</span><br><span class="line">    var self = this;</span><br><span class="line">    var args = Array.prototype.slice.call(arguments, 1);</span><br><span class="line"></span><br><span class="line">    var fBound = function () &#123;</span><br><span class="line">        var bindArgs = Array.prototype.slice.call(arguments);</span><br><span class="line">        // 当作为构造函数时，this 指向实例，此时结果为 true，将绑定函数的 this 指向该实例，可以让实例获得来自绑定函数的值</span><br><span class="line">        // 以上面的是 demo 为例，如果改成 `this instanceof fBound ? null : context`，实例只是一个空对象，将 null 改成 this ，实例会具有 habit 属性</span><br><span class="line">        // 当作为普通函数时，this 指向 window，此时结果为 false，将绑定函数的 this 指向 context</span><br><span class="line">        return self.apply(this instanceof fBound ? this : context, args.concat(bindArgs));</span><br><span class="line">    &#125;</span><br><span class="line">    // 修改返回函数的 prototype 为绑定函数的 prototype，实例就可以继承绑定函数的原型中的值</span><br><span class="line">    fBound.prototype = this.prototype;</span><br><span class="line">    return fBound;</span><br><span class="line">&#125;</span><br><span class="line">// 最终版</span><br><span class="line">Function.prototype.bind = Function.prototypr.bind || function (context)&#123;</span><br><span class="line">    if(typeof this !== &apos;function&apos;)&#123;</span><br><span class="line">        throw new Error(&apos;仅支持函数绑定&apos;)</span><br><span class="line">    &#125;</span><br><span class="line">    const self = this</span><br><span class="line">    const args = Array.prototype.slice.call(arguments,1)</span><br><span class="line">    const fBound = function()&#123;</span><br><span class="line">        const finelArgs = args.concat(Array.prototype.slice.call(arguments))</span><br><span class="line">        // 构造函数调用</span><br><span class="line">        // new 调用时，其实this instanceof bound判断也不是很准确。es6 new.target就是解决这一问题的。</span><br><span class="line">        if(this instance fBound)&#123;</span><br><span class="line">            // 处理原型继承</span><br><span class="line">            if(self.prototype)&#123; //self可能是ES6的箭头函数，没有prototype，所以就没必要再指向做prototype操作。</span><br><span class="line">                fucnton Empty()&#123;&#125;</span><br><span class="line">                Empty.prototype = self.prototype</span><br><span class="line">                fBound.prototype = new Empty()</span><br><span class="line">            &#125;</span><br><span class="line">            // 处理构造函数返回值</span><br><span class="line">            const res = self.apply(this,finalArgs)</span><br><span class="line">            if((typeof res === &quot;object&quot;&amp;&amp; res !==null) || typeof res === &quot;function&quot;)&#123;</span><br><span class="line">                return res</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                return this</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            // 一般绑定</span><br><span class="line">           return self.apply(context,args.concat(finelArgs))</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    // 处理length name 如果不限于es5的话</span><br><span class="line">    Object.define(fBound,&#123;</span><br><span class="line">        &apos;length&apos;:&#123;</span><br><span class="line">            value:self.length</span><br><span class="line">        &#125;,</span><br><span class="line">        name:&#123;</span><br><span class="line">            value:&apos;bind&apos;+self.name</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    return fBound</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// s5-shim源码模拟实现bind时用Function实现了length</span><br><span class="line">var $Array = Array;</span><br><span class="line">var ArrayPrototype = $Array.prototype;</span><br><span class="line">var $Object = Object;</span><br><span class="line">var array_push = ArrayPrototype.push;</span><br><span class="line">var array_slice = ArrayPrototype.slice;</span><br><span class="line">var array_join = ArrayPrototype.join;</span><br><span class="line">var array_concat = ArrayPrototype.concat;</span><br><span class="line">var $Function = Function;</span><br><span class="line">var FunctionPrototype = $Function.prototype;</span><br><span class="line">var apply = FunctionPrototype.apply;</span><br><span class="line">var max = Math.max;</span><br><span class="line">var isCallable = function isCallable(value)&#123;</span><br><span class="line">    if(typeof value !== &apos;function&apos;)&#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">&#125;;</span><br><span class="line">var Empty = function Empty() &#123;&#125;;</span><br><span class="line">// 源码是 defineProperties</span><br><span class="line">// 源码是bind笔者改成bindFn便于测试</span><br><span class="line">FunctionPrototype.bindFn = function bind(that) &#123;</span><br><span class="line">    var target = this;</span><br><span class="line">    if (!isCallable(target)) &#123;</span><br><span class="line">        throw new TypeError(&apos;Function.prototype.bind called on incompatible &apos; + target);</span><br><span class="line">    &#125;</span><br><span class="line">    var args = array_slice.call(arguments, 1);</span><br><span class="line">    var bound;</span><br><span class="line">    var binder = function () &#123;</span><br><span class="line">        if (this instanceof bound) &#123;</span><br><span class="line">            var result = apply.call(</span><br><span class="line">                target,</span><br><span class="line">                this,</span><br><span class="line">                array_concat.call(args, array_slice.call(arguments))</span><br><span class="line">            );</span><br><span class="line">            if ($Object(result) === result) &#123;</span><br><span class="line">                return result;</span><br><span class="line">            &#125;</span><br><span class="line">            return this;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return apply.call(</span><br><span class="line">                target,</span><br><span class="line">                that,</span><br><span class="line">                array_concat.call(args, array_slice.call(arguments))</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    var boundLength = max(0, target.length - args.length);</span><br><span class="line">    var boundArgs = [];</span><br><span class="line">    for (var i = 0; i &lt; boundLength; i++) &#123;</span><br><span class="line">        array_push.call(boundArgs, &apos;$&apos; + i);</span><br><span class="line">    &#125;</span><br><span class="line">    // 这里是Function构造方式生成形参length $1, $2, $3...</span><br><span class="line">    bound = $Function(&apos;binder&apos;, &apos;return function (&apos; + array_join.call(boundArgs, &apos;,&apos;) + &apos;)&#123; return binder.apply(this, arguments); &#125;&apos;)(binder);</span><br><span class="line"></span><br><span class="line">    if (target.prototype) &#123;</span><br><span class="line">        Empty.prototype = target.prototype;</span><br><span class="line">        bound.prototype = new Empty();</span><br><span class="line">        Empty.prototype = null;</span><br><span class="line">    &#125;</span><br><span class="line">    return bound;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="手写reduce"><a href="#手写reduce" class="headerlink" title="手写reduce"></a>手写reduce</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">// mdn polyfill</span><br><span class="line">if(!Array.prototype.reduce)&#123;</span><br><span class="line">    Object.defineProperty(Array.prototype,&apos;reduce&apos;,&#123;</span><br><span class="line">        value:function(callback)&#123;</span><br><span class="line">            if(this===null)&#123;</span><br><span class="line">                throw new TypeError(&apos;reduce call on null or undefined&apos;)</span><br><span class="line">            &#125;</span><br><span class="line">            if(typeof callback !== &apos;function&apos;)&#123;</span><br><span class="line">                throw new TypeError(&apos;callback is not a function&apos;)</span><br><span class="line">            &#125;</span><br><span class="line">            var o = Object(this)</span><br><span class="line">            var len = o.length&gt;&gt;&gt;0</span><br><span class="line">            var k = 0</span><br><span class="line">            var value </span><br><span class="line">            if(arguments.length &gt;= 2)&#123;</span><br><span class="line">                value = arguments[1]</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                // 寻找默认值</span><br><span class="line">                while(k&lt;len &amp;&amp; !(k in o))&#123;</span><br><span class="line">                    k++</span><br><span class="line">                &#125;</span><br><span class="line">                if(k&gt;=len)&#123;</span><br><span class="line">                    throw new TypeError(&apos;reduce of empty array with no initial value)</span><br><span class="line">                &#125;</span><br><span class="line">                value = o[k++] //  value = o[k]; k++</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // 开始迭代运算</span><br><span class="line">            while(k&lt;len)&#123;</span><br><span class="line">               if(k in o)&#123;</span><br><span class="line">                    value = callback(value,o[k],k,o)</span><br><span class="line">               &#125;</span><br><span class="line">               k++</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return value</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>通过reduce 实现 runPromistInSequence按顺序执行promise</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const runPromiseInSequence = (array,value)=&gt;array.reduce(</span><br><span class="line">    (promiseChain,currentPromise)=&gt;promiseChain.then(currentPromise)</span><br><span class="line">    ,Promise.resolve(value)</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过reduce 实现pip，左到右执行顺序</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">const pip = (...functions)=&gt;(initValue)=&gt;functions.reduce((acc,func)=&gt;func(acc),intiValue)</span><br><span class="line"></span><br><span class="line">// 版本2 函数式</span><br><span class="line">const pip = (...functions)=&gt;&#123;</span><br><span class="line">    if(functions.length === 0)&#123;</span><br><span class="line">        return arg =&gt; arg</span><br><span class="line">    &#125;</span><br><span class="line">    if(functions.length === 1)&#123;</span><br><span class="line">        retruen functions[0]</span><br><span class="line">    &#125;</span><br><span class="line">    return functions.reduce((a,b)=&gt;(...args)=&gt;b(a(...args)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过reduce 实现koa 的only</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// only 的应用</span><br><span class="line">var o =&#123;</span><br><span class="line">    a:&apos;a&apos;,</span><br><span class="line">    b:&apos;b&apos;,</span><br><span class="line">    c:&apos;c&apos;</span><br><span class="line">&#125;</span><br><span class="line">only(o,[&apos;a&apos;,&apos;b&apos;]) // &#123;a:&apos;a&apos;,b:&apos;b&apos;&#125;</span><br><span class="line"></span><br><span class="line">// 实现only</span><br><span class="line"></span><br><span class="line">const only = (obj,keys)=&gt;&#123;</span><br><span class="line">    if(typeof keys === &apos;string&apos;)&#123;</span><br><span class="line">        keys = keys.split(/\S+/)</span><br><span class="line">    &#125;</span><br><span class="line">    keys.reduce((res,key)=&gt;&#123;</span><br><span class="line">        if(obj[key] === null) return res</span><br><span class="line">        res[key] = obj[key]</span><br><span class="line">        return res</span><br><span class="line">    &#125;,&#123;&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="手写apply-或者-call"><a href="#手写apply-或者-call" class="headerlink" title="手写apply 或者 call"></a>手写apply 或者 call</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Function.prototype.appy = function(target,args)&#123;</span><br><span class="line">    if(!args)&#123;</span><br><span class="line">        args = []</span><br><span class="line">    &#125;</span><br><span class="line">    if(!target)&#123;</span><br><span class="line">        target = window</span><br><span class="line">    &#125;</span><br><span class="line">    var o = Object(target)</span><br><span class="line">    var fnKey = Symbol()</span><br><span class="line">    o[fnKey] = this</span><br><span class="line">    var res = o[fnKey](...args)</span><br><span class="line">    delete o[fnKey]</span><br><span class="line">    retrun res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// es5版本 call</span><br><span class="line">Function.prototype.call= function(context)&#123;</span><br><span class="line">    context = context||window</span><br><span class="line">    context.fn = this</span><br><span class="line">    // 封装参数 注意从第二个参数开始</span><br><span class="line">    var args = []</span><br><span class="line">    for(var i = 1,len= arguments.lentgh;i&lt;len;i++)&#123;</span><br><span class="line">        args.push(&apos;arguments[&apos;+i+&apos;]&apos;)</span><br><span class="line">    &#125;</span><br><span class="line">    var res = eval(&apos;context.fn(&apos;+args+&apos;)&apos;)</span><br><span class="line">    delete context.fn</span><br><span class="line">    return res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="手写instanceof"><a href="#手写instanceof" class="headerlink" title="手写instanceof"></a>手写instanceof</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">const instanceof = (L,R)&#123;</span><br><span class="line">    if(typeof L !== &apos;object&apos;) retrun false;</span><br><span class="line">    while(true)&#123;</span><br><span class="line">        if(L === null)&#123;</span><br><span class="line">            return false</span><br><span class="line">        &#125;</span><br><span class="line">        if(L.__proto__ === R.prototypr)&#123;</span><br><span class="line">            return true</span><br><span class="line">        &#125;</span><br><span class="line">        L = L.__proto__</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="手写并法法下图片方法，限制最大并法量limit"><a href="#手写并法法下图片方法，限制最大并法量limit" class="headerlink" title="手写并法法下图片方法，限制最大并法量limit"></a>手写并法法下图片方法，限制最大并法量limit</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// loadImg 假定为异步下载图片的方法</span><br><span class="line">const loadByLimit = (urls,loadImg,limit)&#123;</span><br><span class="line">    const copyurls = [...urls]</span><br><span class="line">    cost promie</span><br><span class="line">    if(copyruls.length&lt;=limit)&#123;</span><br><span class="line">        return Promise.all(copyruls.map(url=&gt;loadImg(url)))</span><br><span class="line">    &#125;</span><br><span class="line">    // 注意 splice 会改变copyurls数组  </span><br><span class="line">    const promiseArr = copyurls.splice(0,limit).map(url=&gt;loadImg(url))</span><br><span class="line">    // 对剩下的数组迭代</span><br><span class="line">    copyurls.reduce(</span><br><span class="line">        (prePromise,url)=&gt;prePromise.then(Promise.race(promiseArr))</span><br><span class="line">        .cath(e=&gt;console.error(e))</span><br><span class="line">        .then(resovedUrl=&gt;&#123;</span><br><span class="line">            // 当有一个已经决议时即是下载完成，从promiseArr删除对应promise并往里添加新url</span><br><span class="line">            const hasLoadUrlIndex = promiseArr.findIndex(v=&gt;v.url===resolveUrl)</span><br><span class="line">            promiseArr.splice(hasLoadUrlIndex,1)</span><br><span class="line">            promiseArr.push(oadImg(url))</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line">        ,Promise.resolve())</span><br><span class="line">        .then(()=&gt;Promise.all(promiseArr))</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="MutationObserve-模仿-nextTick"><a href="#MutationObserve-模仿-nextTick" class="headerlink" title="MutationObserve 模仿 nextTick"></a>MutationObserve 模仿 nextTick</h5><p>vue 的nextTick 更倾向于微任务，实现nextTick的api优先级为 Promise.then(微任务) &gt; MutationObserve (微任务) &gt; setTimeout(宏任务) </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">const nextTick = (function()&#123;</span><br><span class="line">    var callbacks = [] </span><br><span class="line">    var pending = false</span><br><span class="line">    var timeFunc  // 模仿异步函数</span><br><span class="line">    const nextTickHandle = function()&#123;</span><br><span class="line">        pending = false // 重置</span><br><span class="line">        var copy = callbacks.slice(0)</span><br><span class="line">        copy.forEach(item=&gt;item())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 实现异步的timeFunc</span><br><span class="line">    if(typeof MutationObserve !== &apos;undefined&apos;)&#123;</span><br><span class="line">        var counter = 1</span><br><span class="line">        var observe = new MutationObserve(nextTickHandel) // 声明MutationObserve回调</span><br><span class="line">        var textNode = document.createTextNode(counter)</span><br><span class="line">        observe.observe(textNode,&#123;</span><br><span class="line">            characterData：true // 一旦文本改变马上触发回调nextTickHandle</span><br><span class="line">        &#125;)</span><br><span class="line">        timeFunc = function()&#123;</span><br><span class="line">            counter = (counter+1)%2 // 执行timeFunc会让文本在0和1开会切换</span><br><span class="line">            textNode.data = counter</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        // 不支持MutationObserve 时回退到setTimeout</span><br><span class="line">        timeFunc = setTimeout</span><br><span class="line">    &#125;</span><br><span class="line">    // 支持cb 和 上下文指定</span><br><span class="line">    return function(cb,context)&#123;</span><br><span class="line">        var func = context? function()&#123;cb.call(context)&#125; : cb</span><br><span class="line">        callbacks.push(func)</span><br><span class="line">        if(pending) return</span><br><span class="line">        pending = true</span><br><span class="line">        timeFunc(nextTickHandle,0)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<h4 id="手写Promise"><a href="#手写Promise" class="headerlink" title="手写Promise"></a>手写Promise</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">// 第一部</span><br><span class="line">// Promise 是一个构造函数，接受一个executor参数在实例化时立即执行</span><br><span class="line">// 至少维护status value reason 几个状态</span><br><span class="line">function Promise(executor)&#123;</span><br><span class="line"> this.status = &apos;pending&apos;</span><br><span class="line"> this.value = null</span><br><span class="line"> this.reason = null</span><br><span class="line"> this.onfullfilledArr = [] // 用于存多个then onfullfilled回调</span><br><span class="line"> this.onrejectedArr = [] // 用于存多个then nrejected回调</span><br><span class="line"></span><br><span class="line">// resove 为异步执行</span><br><span class="line">// 一个promise实例只能决议一次</span><br><span class="line"> const resolve = value=&gt;&#123;</span><br><span class="line">     // 如果value 是promise实例</span><br><span class="line">     if(value instanceof Promise)&#123;</span><br><span class="line">         return value.then(resolve,reject)</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     // 使用上面nextTick函数模拟异步</span><br><span class="line">     nextTick(()=&gt;&#123;</span><br><span class="line">         if(this.status === &apos;pending&apos;)&#123;</span><br><span class="line">         this.value = value</span><br><span class="line">         this.status = &apos;fullfilled&apos;</span><br><span class="line"></span><br><span class="line">         // 执行then onfullfilled回调</span><br><span class="line">         this.onfullfilledArr.forEach(cb=&gt;cb(value))</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">// reject 为异步执行</span><br><span class="line">// 一个promise实例只能决议一次</span><br><span class="line"> const reject = reason=&gt;&#123;</span><br><span class="line">      // 使用上面nextTick函数模拟异步</span><br><span class="line">     nextTick(()=&gt;&#123;</span><br><span class="line">          if(this.status === &apos;pending&apos;)&#123;</span><br><span class="line">         this.reason = reason</span><br><span class="line">         this.status = &apos;rejected&apos;</span><br><span class="line"></span><br><span class="line">           // 执行then onfullfilled回调</span><br><span class="line">         this.onrejectedArr.forEach(cb=&gt;cb(reason))</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;)</span><br><span class="line">     </span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> // 立即执行executor 并捕捉错误</span><br><span class="line"> try&#123;</span><br><span class="line">     executor()</span><br><span class="line"></span><br><span class="line"> &#125;catch(e)&#123;</span><br><span class="line">     reject(e)</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">Promise.prototype.then = function(onfullfilled,onrejected)&#123;</span><br><span class="line">    onfullfilled = typeof onfullfilled === &apos;function&apos;?onfullfilled: data=&gt;data // ata=&gt;data 用于then 穿透</span><br><span class="line">    onrejected = typeof onrejected === &apos;function&apos;?onrejected: error=&gt;throw error  </span><br><span class="line"></span><br><span class="line">    let promise2 // promise2 将作为then的返回值</span><br><span class="line"></span><br><span class="line">    if(this.status === &apos;fullfilled&apos;)&#123;</span><br><span class="line">        return promise2 = new Promise((resolve,reject)=&gt;&#123;</span><br><span class="line">            nextTick(()=&gt;&#123;</span><br><span class="line">                try&#123;</span><br><span class="line">                    let res = onfullfilled(this.value)</span><br><span class="line">                    //resolve(res) // 只能处理res是普通值情况</span><br><span class="line">                    resolvePromise(promise2,res,resolve,reject) // res 可能是一个promise实例也可能是普通值，统一处理</span><br><span class="line">                &#125;catch(e=&gt;reject(e))</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    if(this.status === &apos;rejected&apos;)&#123;</span><br><span class="line">        return promise2 = new Promise((resolve,reject)=&gt;&#123;</span><br><span class="line">            nextTick(()=&gt;&#123;</span><br><span class="line">                try&#123;</span><br><span class="line">                    let res = onrejected(this.value)</span><br><span class="line">                   //resolve(res) // 只能处理res是普通值情况</span><br><span class="line">                    resolvePromise(promise2,res,resolve,reject) // res 可能是一个promise实例也可能是普通值，统一处理</span><br><span class="line">                &#125;catch(e=&gt;reject(e))</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    if(this.status === &apos;pending&apos;)&#123;</span><br><span class="line">        return promise2 = new Promise((resolve,reject)=&gt;&#123;</span><br><span class="line">            this.onfullfillArr.push(()=&gt;&#123;</span><br><span class="line">                 try&#123;</span><br><span class="line">                    let res = onrejected(this.value)</span><br><span class="line">                    //resolve(res) // 只能处理res是普通值情况</span><br><span class="line">                    resolvePromise(promise2,res,resolve,reject) // res 可能是一个promise实例也可能是普通值，统一处理</span><br><span class="line">                &#125;catch(e=&gt;reject(e))</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">             this.onrejectedArr.push(()=&gt;&#123;</span><br><span class="line">                 try&#123;</span><br><span class="line">                    let res = onrejected(this.value)</span><br><span class="line">                    resolve(res)</span><br><span class="line">                &#125;catch(e=&gt;reject(e))</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 完善 resolvePromise(promise2,res,resolve,reject)</span><br><span class="line"> var resolvePromise = promise2,result,resolve,reject)=&gt;&#123;</span><br><span class="line">     if(result === promise2)&#123;</span><br><span class="line">         reject(TypeError(&apos;死循环&apos;))</span><br><span class="line">     &#125;</span><br><span class="line">     let consumed = false // 是否已经决议</span><br><span class="line">     let isthenable = obj=&gt; obj &amp;&amp; obj.then &amp;&amp; (typeof obj.then === &apos;function&apos;)</span><br><span class="line">     </span><br><span class="line">     if(result instanceof Promise)&#123;</span><br><span class="line">         // 是promise</span><br><span class="line">         if(result.status === &apos;pending&apos;)&#123;</span><br><span class="line">             result.then(data=&gt;&#123;</span><br><span class="line">                 resolvePromise(promise2,data,resove,reject)</span><br><span class="line">             &#125;,reject)</span><br><span class="line">         &#125;else&#123;</span><br><span class="line">             result.then(resolve,reject)</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">     &#125;else if(isthenable(result))&#123;</span><br><span class="line">         // 是thenable</span><br><span class="line">         let thenable = result.then</span><br><span class="line">         thenable.call(result,data=&gt;&#123;</span><br><span class="line">             if(consumed) return</span><br><span class="line">             consumed = true</span><br><span class="line">            return  resolvePromise(promise2,data,resove,reject)</span><br><span class="line">         &#125;,error=&gt;&#123;</span><br><span class="line">            if(consumed) return</span><br><span class="line">             consumed = true</span><br><span class="line">            return reject(error)</span><br><span class="line">         &#125;)</span><br><span class="line"></span><br><span class="line">     &#125;else&#123;</span><br><span class="line">         // 返回普通值</span><br><span class="line">         resolve(result)</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>Promise静态方法的实现</p>
<ul>
<li><p>Promise.prototype.catch</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Promise.prototype.catch = function(errorcallback)&#123;</span><br><span class="line">    return this.then(unll,errorcallback)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Promise.resolve 或者 Promise.reject</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Promise.resolve = function(value)&#123;</span><br><span class="line">    return new Promise((resolve,reject)=&gt;&#123;</span><br><span class="line">        resolve(value)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Promise.all<br> 全部完成才算完成，一个错误就结束</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Promise.all = function(promiseArr)&#123;</span><br><span class="line">    if(!Array.isArray(promiseArr))&#123;</span><br><span class="line">        throw new Error(&apos;&apos;)</span><br><span class="line">    &#125;</span><br><span class="line">  return new Promise((resolve,reject)=&gt;&#123;</span><br><span class="line">      let res = []</span><br><span class="line">      try&#123;</span><br><span class="line">          promiseArr.forEach(p=&gt;&#123;</span><br><span class="line">              p.then((data)=&gt;&#123;</span><br><span class="line">                  res.push(data)</span><br><span class="line">                  if(res.length === promiseArr.length)&#123;</span><br><span class="line">                      resolve(res)</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">              &#125;,reject)</span><br><span class="line">          &#125;)</span><br><span class="line"></span><br><span class="line">      &#125;catch(e)&#123;</span><br><span class="line">          reject(e)</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Promise.race</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Promise.race = function(promiseArr)&#123;</span><br><span class="line">     if(!Array.isArray(promiseArr))&#123;</span><br><span class="line">        throw new Error(&apos;&apos;)</span><br><span class="line">    &#125;</span><br><span class="line">  return new Promise((resolve,reject)=&gt;&#123;</span><br><span class="line">      try&#123;</span><br><span class="line">          promiseArr.forEach(p=&gt;&#123;</span><br><span class="line">              p.then(resolve,reject)</span><br><span class="line">          &#125;)</span><br><span class="line"></span><br><span class="line">      &#125;catch(e)&#123;</span><br><span class="line">          reject(e)</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Promise.allSettled<br>Promise.all 的问题是一旦有请求失败就会抛出错误，然而有时候希望某个请求失败后，其他请求的结果能够正常返回，针对这种情况ES11(ECMAScript2020)引入Promise.allSettled，成功的promise将返回一个包含status和value的对象，失败的promise将返回一个包含status和reason的对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Promise.allSettled = Promise.allSettled || function(promises)&#123;</span><br><span class="line">    return new Promise(function(resolve,reject)&#123;</span><br><span class="line">        if(Array.isArray(promises))&#123;</span><br><span class="line">            return reject(new TypeError(&apos;参数不是数组&apos;))</span><br><span class="line">        &#125;</span><br><span class="line">        let resovedCounter = 0</span><br><span class="line">        let res = new Array(promises.length)</span><br><span class="line">        promises.forEach(function(p,index)&#123;</span><br><span class="line">            p.then(function(data)&#123;</span><br><span class="line">                resovedCounter++</span><br><span class="line">                res[index] = &#123;status:true,value:data&#125;</span><br><span class="line">                if(res.length === promises.length)&#123;</span><br><span class="line">                    return resove(res)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,function(reason)&#123;</span><br><span class="line">                 resovedCounter++</span><br><span class="line">                  res[index] = &#123;status:false,value:reason&#125;</span><br><span class="line">                  </span><br><span class="line">                   if(res.length === promises.length)&#123;</span><br><span class="line">                    return resove(res)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="手写-new"><a href="#手写-new" class="headerlink" title="手写 new"></a>手写 new</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function newFunc(...arg)&#123;</span><br><span class="line">    // 取构造函数</span><br><span class="line">    let constructor = arg.shift()</span><br><span class="line">    // 创建新对象,实现 obj.__prpto__ === constructor.prototype</span><br><span class="line">    let obj = Object.create(constructor.prototype)</span><br><span class="line"></span><br><span class="line">    // 调用构造函数</span><br><span class="line">    let res = constructor.apply(obj,arg)</span><br><span class="line"></span><br><span class="line">    return (typeof res ===&apos;object&apos; &amp;&amp; res !==null)? res:obj</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="es5中相对可用的继承"><a href="#es5中相对可用的继承" class="headerlink" title="es5中相对可用的继承"></a>es5中相对可用的继承</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">function inherit(Child,Parent)&#123;</span><br><span class="line">    // 继承父类原型上的属性</span><br><span class="line">    Child.prototype = Object.create(Parent.prototype) // 等价于 Child.prototype.__proto__ === Parent.prototype</span><br><span class="line"></span><br><span class="line">    // 此时Child的构造函数已变为Parent 修改构造函数为Child</span><br><span class="line">    Child.prototype.constructor = Child</span><br><span class="line"></span><br><span class="line">    // 继承父类静态属性和方法 setPrototypeOf 与 Object.prototype.__proto__等价</span><br><span class="line">    if(Object.setPropertyOf)&#123;</span><br><span class="line">        Object.setPropertyOf(Child,Parent) // 等价于 Child.__proto__ === Parent</span><br><span class="line">    &#125;else if(Child.__proto__)&#123;</span><br><span class="line">        Child.__proto__ = Parent</span><br><span class="line"></span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        // </span><br><span class="line">        var Fn = function()&#123;</span><br><span class="line">            for(var k in Parent)&#123;</span><br><span class="line">                Object.defineProperty(this,k,&#123;</span><br><span class="line">                    value: Parent[k]</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Fn.prototype = Parent</span><br><span class="line">        return new Fn()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="es7-Decorator-的Babel编译"><a href="#es7-Decorator-的Babel编译" class="headerlink" title="es7 Decorator 的Babel编译"></a>es7 Decorator 的Babel编译</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">class Person&#123;</span><br><span class="line">    @log // 举例用在类方法上,在类上的装饰器有些不同</span><br><span class="line">    say()&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function log(target,key,descriptor)&#123;</span><br><span class="line"></span><br><span class="line">    // 返回 descriptor</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// babel</span><br><span class="line">_applyDecoratorDescriptor(</span><br><span class="line">    Person.prototype，</span><br><span class="line">    ‘say&apos;,</span><br><span class="line">    [log],</span><br><span class="line">    Object.getOwnPropertyDescriptor(Person.prototype,&apos;say&apos;),</span><br><span class="line">    Person.prototype</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">var _applyDecoratorDescriptor = function(target,property,decorators,descriptor,context)&#123;</span><br><span class="line">    var desc = &#123;&#125;</span><br><span class="line">    Object.keys(&apos;descriptor&apos;).forEach(function(key)&#123;</span><br><span class="line">        desc[key] = descriptor[key]</span><br><span class="line">    &#125;)</span><br><span class="line">    desc.enumerable = !!desc.enumerable</span><br><span class="line">    desc.configrable = !!desc.configrable</span><br><span class="line"></span><br><span class="line">    if(&apos;value&apos; in desc || desc.initializer)&#123;</span><br><span class="line">        desc.writable = true</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    desc = decorators.slice().reverse().reduce(function(desc,decrator)&#123;</span><br><span class="line">        return decorator(target,property,desc)|| desc</span><br><span class="line"></span><br><span class="line">    &#125;,desc)</span><br><span class="line"></span><br><span class="line">    if(context &amp;&amp; desc.initializer !== void 0)&#123;</span><br><span class="line">        desc.value = desc.initializer?desc.initializer.call(context):void 0</span><br><span class="line">        desc.initializer = undefined</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(desc.initializer === void 0)&#123;</span><br><span class="line">        Object.defineProperty(target,property,desc)</span><br><span class="line">        desc = null</span><br><span class="line">    &#125;</span><br><span class="line">    return desc</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>

            <div class="post-copyright">
    <div class="content">
        <p>最后更新： 2020年12月14日 17:14</p>
        <p>原始链接： <a class="post-url" href="/2020/07/02/js/" title="js手写">https://luhu9012.github.io/2020/07/02/js/</a></p>
        <footer>
            <a href="https://luhu9012.github.io">
                <img src="/images/logo.png" alt="luhu9012">
                luhu9012
            </a>
        </footer>
    </div>
</div>

      
        
            

        
    </div>
    <footer class="article-footer">
        
        
<div class="post-share">
    <a href="javascript:;" id="share-sub" class="post-share-fab">
        <i class="fa fa-share-alt"></i>
    </a>
    <div class="post-share-list" id="share-list">
        <ul class="share-icons">
          <li>
            <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://luhu9012.github.io/2020/07/02/js/&title=《js手写》 — 前端笔记&pic=https://luhu9012.github.ioimages/logo.png" data-title="微博">
              <i class="fa fa-weibo"></i>
            </a>
          </li>
          <li>
            <a class="weixin share-sns" id="wxFab" href="javascript:;" data-title="微信">
              <i class="fa fa-weixin"></i>
            </a>
          </li>
          <li>
            <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://luhu9012.github.io/2020/07/02/js/&title=《js手写》 — 前端笔记&source=" data-title="QQ">
              <i class="fa fa-qq"></i>
            </a>
          </li>
          <li>
            <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://luhu9012.github.io/2020/07/02/js/" data-title="Facebook">
              <i class="fa fa-facebook"></i>
            </a>
          </li>
          <li>
            <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《js手写》 — 前端笔记&url=https://luhu9012.github.io/2020/07/02/js/&via=https://luhu9012.github.io" data-title="Twitter">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
          <li>
            <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://luhu9012.github.io/2020/07/02/js/" data-title="Google+">
              <i class="fa fa-google-plus"></i>
            </a>
          </li>
        </ul>
     </div>
</div>
<div class="post-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;" id="wxShare-close">×</a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=https://luhu9012.github.io/2020/07/02/js/" alt="微信分享二维码">
</div>

<div class="mask"></div>

        
        <ul class="article-footer-menu">
            
            
        </ul>
        
    </footer>
  </div>
</article>


    <aside class="post-toc-pos post-toc-top" id="post-toc">
        <nav class="post-toc-wrap">
            <ol class="post-toc"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#手写bind"><span class="post-toc-text">手写bind</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#手写reduce"><span class="post-toc-text">手写reduce</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#手写apply-或者-call"><span class="post-toc-text">手写apply 或者 call</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#手写instanceof"><span class="post-toc-text">手写instanceof</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#手写并法法下图片方法，限制最大并法量limit"><span class="post-toc-text">手写并法法下图片方法，限制最大并法量limit</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#MutationObserve-模仿-nextTick"><span class="post-toc-text">MutationObserve 模仿 nextTick</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#手写Promise"><span class="post-toc-text">手写Promise</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#手写-new"><span class="post-toc-text">手写 new</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#es5中相对可用的继承"><span class="post-toc-text">es5中相对可用的继承</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#es7-Decorator-的Babel编译"><span class="post-toc-text">es7 Decorator 的Babel编译</span></a></li></ol>
        </nav>
    </aside>
    

<nav id="article-nav">
  
    <a href="/2020/07/02/jsSingularity/" id="article-nav-newer" class="article-nav-link-wrap">

      <span class="article-nav-title">
        <i class="fa fa-hand-o-left" aria-hidden="true"></i>
        
          js奇技淫巧
        
      </span>
    </a>
  
  
    <a href="/2020/06/10/css-consept/" id="article-nav-older" class="article-nav-link-wrap">
      <span class="article-nav-title">css相关概念</span>
      <i class="fa fa-hand-o-right" aria-hidden="true"></i>
    </a>
  
</nav>



    
</section>
        
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info" class="inner">
      
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


      <p>
        Powered by  <a href="http://hexo.io/" target="_blank">Hexo</a>
        Theme <a href="//github.com/wongminho/hexo-theme-miho" target="_blank">MiHo</a>
      &copy; 2021 luhu9012<br>
      </p>
    </div>
  </div>
</footer>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script>
  var mihoConfig = {
      root: "https://luhu9012.github.io",
      animate: true,
      isHome: false,
      share: true,
      reward: 0
  }
</script>
<div class="sidebar">
    <div id="sidebar-search" title="Search">
        <i class="fa fa-search"></i>
    </div>
    <div id="sidebar-category" title="Categories">
        <i class="fa fa-book"></i>
    </div>
    <div id="sidebar-tag" title="Tags">
        <i class="fa fa-tags"></i>
    </div>
    <div id="sidebar-top">
        <span class="sidebar-top-icon"><i class="fa fa-angle-up"></i></span>
    </div>
</div>
<div class="sidebar-menu-box" id="sidebar-menu-box">
    <div class="sidebar-menu-box-container">
        <div id="sidebar-menu-box-categories">
            <a class="category-link" href="/categories/bom/">bom</a><a class="category-link" href="/categories/css/">css</a><a class="category-link" href="/categories/js实践/">js实践</a><a class="category-link" href="/categories/js异步编程/">js异步编程</a><a class="category-link" href="/categories/动画/">动画</a><a class="category-link" href="/categories/框架/">框架</a><a class="category-link" href="/categories/设计模式/">设计模式</a><a class="category-link" href="/categories/项目/">项目</a>
        </div>
        <div id="sidebar-menu-box-tags">
            <a href="/tags/async-异步/" style="font-size: 10px;">async 异步</a> <a href="/tags/bfc/" style="font-size: 10px;">bfc</a> <a href="/tags/css-概念/" style="font-size: 10px;">css 概念</a> <a href="/tags/css动画-js动画/" style="font-size: 10px;">css动画 js动画</a> <a href="/tags/es6-语法/" style="font-size: 10px;">es6 语法</a> <a href="/tags/javaSciript/" style="font-size: 20px;">javaSciript</a> <a href="/tags/js-函数/" style="font-size: 10px;">js 函数</a> <a href="/tags/js-机制/" style="font-size: 10px;">js 机制</a> <a href="/tags/js基础-js运行机制/" style="font-size: 10px;">js基础 js运行机制</a> <a href="/tags/oop/" style="font-size: 10px;">oop</a> <a href="/tags/vue-js/" style="font-size: 10px;">vue.js</a> <a href="/tags/垂直居中/" style="font-size: 10px;">垂直居中</a> <a href="/tags/奇技淫巧/" style="font-size: 10px;">奇技淫巧</a> <a href="/tags/性能/" style="font-size: 16.67px;">性能</a> <a href="/tags/文件上传/" style="font-size: 13.33px;">文件上传</a> <a href="/tags/树/" style="font-size: 10px;">树</a> <a href="/tags/浏览器-V8/" style="font-size: 10px;">浏览器  V8</a> <a href="/tags/跨域/" style="font-size: 10px;">跨域</a> <a href="/tags/项目/" style="font-size: 13.33px;">项目</a>
        </div>
    </div>
    <a href="javascript:;" class="sidebar-menu-box-close">&times;</a>
</div>
<div class="mobile-header-menu-nav" id="mobile-header-menu-nav">
    <div class="mobile-header-menu-container">
        <span class="title">Menus</span>
        <ul class="mobile-header-menu-navbar">
            
            <li>
                <a  href="/">
                    <i class="fa fa-home"></i><span>Home</span>
                </a>
            </li>
            
            <li>
                <a  href="/archives">
                    <i class="fa fa-archive"></i><span>Archives</span>
                </a>
            </li>
            
            <li>
                <a  href="/about">
                    <i class="fa fa-user"></i><span>About</span>
                </a>
            </li>
            
        </ul>
    </div>
    <div class="mobile-header-tag-container">
        <span class="title">Tags</span>
        <div id="mobile-header-container-tags">
            <a href="/tags/async-异步/" style="font-size: 10px;">async 异步</a> <a href="/tags/bfc/" style="font-size: 10px;">bfc</a> <a href="/tags/css-概念/" style="font-size: 10px;">css 概念</a> <a href="/tags/css动画-js动画/" style="font-size: 10px;">css动画 js动画</a> <a href="/tags/es6-语法/" style="font-size: 10px;">es6 语法</a> <a href="/tags/javaSciript/" style="font-size: 20px;">javaSciript</a> <a href="/tags/js-函数/" style="font-size: 10px;">js 函数</a> <a href="/tags/js-机制/" style="font-size: 10px;">js 机制</a> <a href="/tags/js基础-js运行机制/" style="font-size: 10px;">js基础 js运行机制</a> <a href="/tags/oop/" style="font-size: 10px;">oop</a> <a href="/tags/vue-js/" style="font-size: 10px;">vue.js</a> <a href="/tags/垂直居中/" style="font-size: 10px;">垂直居中</a> <a href="/tags/奇技淫巧/" style="font-size: 10px;">奇技淫巧</a> <a href="/tags/性能/" style="font-size: 16.67px;">性能</a> <a href="/tags/文件上传/" style="font-size: 13.33px;">文件上传</a> <a href="/tags/树/" style="font-size: 10px;">树</a> <a href="/tags/浏览器-V8/" style="font-size: 10px;">浏览器  V8</a> <a href="/tags/跨域/" style="font-size: 10px;">跨域</a> <a href="/tags/项目/" style="font-size: 13.33px;">项目</a>
        </div>
    </div>
</div>
<div class="search-wrap">
    <span class="search-close">&times;</span>
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
            <i class="icon icon-lg icon-chevron-left"></i>
        </a>
        <input class="search-field" placeholder="Search..." id="keywords">
        <a id="search-submit" href="javascript:;">
            <i class="fa fa-search"></i>
        </a>
    <div class="search-container" id="search-container">
        <ul class="search-result" id="search-result">
        </ul>
    </div>
</div>

<div id="search-tpl">
    <li class="search-result-item">
        <a href="{url}" class="search-item-li">
            <span class="search-item-li-title" title="{title}">{title}</span>
        </a>
    </li>
</div>
<script src="/js/search.js"></script>
<script src="/js/main.js"></script>


  <script src="//cdn.bootcss.com/particles.js/2.0.0/particles.min.js"></script>
  <div id="particles"></div>
  <script src="/js/particles.js"></script>







  <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  <script src="//cdn.bootcss.com/scrollReveal.js/3.0.5/scrollreveal.js"></script>
  <script src="/js/animate.js"></script>


  <script src="/js/pop-img.js"></script>
  <script>
     $(".article-entry p img").popImg();
  </script>

  </div>
</body>
</html>